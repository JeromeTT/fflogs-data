<!DOCTYPE html>
<meta charset="utf-8" />
<html lang="en">
  <head>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />

    <link rel="stylesheet" href="index.css" />
    <!-- Create a div where the graph will take place -->
    <h1>Updates every 8 hours, starting 2:00 AM AEST??</h1>
    <h4 id="trackedPulls">Total tracked pulls:</h4>

    <img src="https://cdn.7tv.app/emote/62348f3b73f35ccbda40810c/4x.webp" />
    <div class="container-fluid">
      <div class="container-xxl" style="background-color: white">
        <div class="row">
          <div class="col-sm-12 col-md-12, col-lg-8">"<canvas id="scatter"></canvas></div>
          <div class="col-sm-12 col-md-6, col-lg-4">
            <p>
              <a
                class="btn btn-primary btn-lg btn-block"
                data-bs-toggle="collapse"
                href="#collapseExample"
                role="button"
                aria-expanded="false"
                aria-controls="collapseExample"
              >
                History of Best Pulls
              </a>
            </p>
            <div class="collapse show" id="collapseExample">
              <div class="card card-body">
                <div style="color: black; overflow-y: scroll; height: 400px" id="newBests"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      //Read the data
      d3.csv("https://raw.githubusercontent.com/JeromeTT/fflogs-data/main/output.csv").then(function (data) {
        console.log(data);
        data = data.map((row, index) => ({ ...row, Index: index }));
        console.log(data);
        b = data.reduce((a, row) => {
          DefaType = row.P3Defamation;
          a[DefaType] != undefined ? a[DefaType]++ : (a[DefaType] = 0);
          return a;
        }, {});

        delete b["N"];

        phaseDataset = [1, 2, 3, 4, 5, 6].map((p) => ({
          label: "P" + p,
          data: data
            .filter((row) => row.LastPhase == p)
            .map((row) => ({
              x: row.Index,
              y: row.PullDuration / 1000,
              ...row,
            })),
        }));
        Chart.defaults.font.size = 20;

        const scatterChart = new Chart(document.getElementById("scatter"), {
          type: "scatter",
          options: {
            scales: {
              x: {
                type: "linear",
                position: "bottom",
              },
            },
          },
          data: {
            labels: ["what"],
            datasets: phaseDataset,
          },
        });
        function clickHandler(click) {
          const points = scatterChart.getElementsAtEventForMode(click, "nearest", { intersect: true }, true);
          if (points.length) {
            const firstPoint = points[0];
            console.log(firstPoint);
            console.log(firstPoint.datasetIndex);
            console.log(firstPoint.index);
            var test = phaseDataset[firstPoint.datasetIndex].data[firstPoint.index];
            console.log(test);
            var link = "https://www.fflogs.com/reports/" + test.LogID + "#fight=" + test.PullNumber;
            window.open(link);
            console.log(link);
          }
        }

        document.getElementById("scatter").onclick = clickHandler;
        document.getElementById("trackedPulls").innerHTML = "Total tracked pulls: " + data.length;
      });

      d3.csv("https://raw.githubusercontent.com/JeromeTT/fflogs-data/main/topPersonalBest.csv").then(function (data) {
        newBests = document.getElementById("newBests");
        data.map((row) => {
          var a = document.createElement("p");
          newBests.insertAdjacentElement("beforeend", a);
          var date = new Date(row.LogStartTime * 1);
          var b = document.createElement("a");
          b.innerHTML = "log";
          b.href = "https://www.fflogs.com/reports/" + row.LogID + "#fight=" + row.PullNumber;
          b.target = "_blank";
          a.innerHTML =
            " - " +
            date
              .toLocaleDateString("en-AU", {
                day: "numeric",
                month: "short",
                year: "numeric",
              })
              .split(" ")
              .join("-") +
            " - Phase: " +
            row.LastPhase +
            " " +
            row.BossPercentage +
            "% ";
          a.insertBefore(b, a.firstChild);
        });
      });
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
      integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"
      integrity="sha384-mQ93GR66B00ZXjt0YO5KlohRA5SY2XofN4zfuZxLkoj1gXtW8ANNCe9d5Y3eG5eD"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
